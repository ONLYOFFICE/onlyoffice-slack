<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, caller-scalable=no, minimal-ui" />
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="mobile-web-app-capable" content="yes" />
        <!--
        *
        * (c) Copyright Ascensio System SIA 2022
        *
        * Licensed under the Apache License, Version 2.0 (the "License");
        * you may not use this file except in compliance with the License.
        * You may obtain a copy of the License at
        *
        *     http://www.apache.org/licenses/LICENSE-2.0
        *
        * Unless required by applicable law or agreed to in writing, software
        * distributed under the License is distributed on an "AS IS" BASIS,
        * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
        * See the License for the specific language governing permissions and
        * limitations under the License.
        *
        -->
        <title>ONLYOFFICE</title>
        <link rel="icon" type="image/x-icon" href="/favicon.ico">
        <style>
            html {
                height: 100%;
                width: 100%;
            }

            body {
                background: #fff;
                color: #333;
                font-family: Arial, Tahoma,sans-serif;
                font-size: 12px;
                font-weight: normal;
                height: 100%;
                margin: 0;
                overflow-y: hidden;
                padding: 0;
                text-decoration: none;
            }

            .form {
                height: 100%;
            }

            div {
                margin: 0;
                padding: 0;
            }
        </style>

        <script type="text/javascript" th:src="@{${apijs}}"></script>

        <script th:inline="javascript">
                var docEditor;

                var innerAlert = function (message, inEditor) {
                    if (console && console.log)
                        console.log(message);
                    if (inEditor && docEditor)
                        docEditor.showMessage(message);
                };

                // the application is loaded into the browser
                var onAppReady = function () {
                    innerAlert("Document editor ready");
                };

                // the document is modified
                var onDocumentStateChange = function (event) {
                    var title = document.title.replace(/\*$/g, "");
                    document.title = title + (event.data ? "*" : "");
                };

                // the caller is trying to switch the document from the viewing into the editing mode
                var onRequestEditRights = function () {
                    location.href = location.href.replace(RegExp("\&?action=view\&?", "i"), "");
                };

                // an error or some other specific event occurs
                var onError = function (event) {
                    if (event) innerAlert(event.data);
                };

                // the document is opened for editing with the old document.key value
                var onOutdatedVersion = function (event) {
                    location.reload(true);
                };

                // replace the link to the document which contains a bookmark
                var replaceActionLink = function(href, linkParam) {
                    var link;
                    var actionIndex = href.indexOf("&actionLink=");
                    if (actionIndex != -1) {
                        var endIndex = href.indexOf("&", actionIndex + "&actionLink=".length);
                        if (endIndex != -1) {
                            link = href.substring(0, actionIndex) + href.substring(endIndex) + "&actionLink=" + encodeURIComponent(linkParam);
                        } else {
                            link = href.substring(0, actionIndex) + "&actionLink=" + encodeURIComponent(linkParam);
                        }
                    } else {
                        link = href + "&actionLink=" + encodeURIComponent(linkParam);
                    }
                    return link;
                }

                // the caller is trying to get link for opening the document which contains a bookmark, scrolling to the bookmark position
                var onMakeActionLink = function (event) {
                    var actionData = event.data;
                    var linkParam = JSON.stringify(actionData);
                    docEditor.setActionLink(replaceActionLink(location.href, linkParam));
                };

                // the meta information of the document is changed via the meta command
                var onMetaChange = function (event) {
                    var favorite = !!event.data.favorite;
                    var title = document.title.replace(/^\☆/g, "");
                    document.title = (favorite ? "☆" : "") + title;
                    docEditor.setFavorite(favorite);
                };

                var onDownloadAs = function(e) {
                    console.log(e);
                };

                var config = [[${config}]];

                var onRequestSaveAs = function (event) {  //  the caller is trying to save file by clicking Save Copy as... button
                    var title = event.data.title;
                    var url = event.data.url;
                    var data = {
                        title: title,
                        url: url
                    };
                    let xhr = new XMLHttpRequest();
                    xhr.open("POST", "saveas");
                    xhr.setRequestHeader( 'Content-Type', 'application/json');
                    xhr.send(JSON.stringify(data));
                    xhr.onload = function () {
                        innerAlert(xhr.responseText);
                        innerAlert(JSON.parse(xhr.responseText).file, true);
                    }
                };

                config.width = "100%";
                config.height = "100%";
                config.events = {
                    "onAppReady": onAppReady,
                    "onDocumentStateChange": onDocumentStateChange,
                    'onRequestEditRights': onRequestEditRights,
                    "onError": onError,
                    "onOutdatedVersion": onOutdatedVersion,
                    "onMakeActionLink": onMakeActionLink,
                    "onMetaChange": onMetaChange,
                    "onDownloadAs": onDownloadAs,
                };

                var сonnectEditor = function () {
                    if ((config.document.fileType === "docxf" || config.document.fileType === "oform")
                        && DocsAPI.DocEditor.version().split(".")[0] < 7) {
                        innerAlert("Please update ONLYOFFICE Docs to version 7.0 to work on fillable forms online.");
                        return;
                    }
                    try {
                        docEditor = new DocsAPI.DocEditor("iframeEditor", config);
                    } catch (e) {
                        location.replace(`${window.location.origin}/onlyoffice/error`);
                    }
                };

                if (window.addEventListener) {
                    window.addEventListener("load", сonnectEditor);
                } else if (window.attachEvent) {
                    window.attachEvent("load", сonnectEditor);
                }
        </script>

    </head>
    <body>
        <div class="form">
            <div id="iframeEditor"></div>
        </div>
    </body>
</html>
